<div class="container">
    <style>
        /* WordPress環境での競合を避けるため、bodyのスタイルは削除または調整が必要な場合があります */
        /* body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-size: 1.2rem;
            transition: background-color 1s ease;
        } */

        .container {
            background-color: white;
            padding: 3rem; /* パディングを大きくする */
            border-radius: 10px; /* 角を少し丸くする */
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            text-align: center;
            width: 90%;
            max-width: 500px; /* コンテナの最大幅を設定 */
            margin: 20px auto; /* 中央寄せと上下のマージン */
        }

        h1 {
            color: #333;
            font-size: 2.5rem; /* 見出しを大きく */
        }

        #score {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 0.5rem; /* マージンを調整 */
        }

        #stats-container {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 1.5rem;
        }

        #stats-container span {
            margin: 0 0.5rem;
        }

        #quiz-container {
            margin: 2rem 0;
        }

        #question {
            font-size: 2.5rem; /* 問題文を大きく */
            margin-bottom: 1.5rem;
        }

        #timer-container {
            margin-bottom: 1rem;
        }

        #timer {
            font-size: 1.8rem;
            font-weight: bold;
            color: #007bff;
        }

        #answer {
            padding: 0.8rem;
            font-size: 1.5rem; /* 入力欄を大きく */
            width: 150px;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 5px;
        }

        #submit {
            padding: 0.8rem 1.5rem;
            font-size: 1.5rem; /* ボタンを大きく */
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            margin-left: 0.5rem;
        }

        #result {
            font-size: 1.8rem; /* 結果表示を大きく */
            font-weight: bold;
            min-height: 2.2rem; /* 高さを確保してレイアウトのズレを防ぐ */
        }

        #play-again {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.2rem;
            cursor: pointer;
            border: none;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
            display: none; /* 初期状態では非表示 */
        }

        #start-screen {
            margin-top: 20px;
        }

        #start-quiz-button {
            padding: 15px 30px;
            font-size: 1.8rem;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        #start-quiz-button:hover {
            background-color: #0056b3;
        }

        /* クイズコンテナを初期状態で非表示にする */
        #quiz-container,
        #score,
        #stats-container,
        #result {
            display: none;
        }
    </style>

    <h1>計算クイズ</h1>
    <p id="score">スコア: 0</p>
    <div id="stats-container">
        <span id="attempts">問題数: 0</span>
        <span id="accuracy">正答率: ---</span>
    </div>
    <div id="quiz-container">
        <p id="question"></p>
        <div id="timer-container">
            <span id="timer"></span>
        </div>
        <input type="number" id="answer" placeholder="答えを入力">
        <button id="submit">こたえる</button>
    </div>
    <p id="result"></p>
    <button id="play-again">もう一度プレイ</button>

    <div id="start-screen">
        <button id="start-quiz-button">クイズスタート</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const questionElement = document.getElementById('question');
        const answerElement = document.getElementById('answer');
        const submitButton = document.getElementById('submit');
        const resultElement = document.getElementById('result');
        const scoreElement = document.getElementById('score');
        const attemptsElement = document.getElementById('attempts');
        const accuracyElement = document.getElementById('accuracy');
        const timerElement = document.getElementById('timer');
        const playAgainButton = document.getElementById('play-again'); // ボタン要素を取得
        const startQuizButton = document.getElementById('start-quiz-button');
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const scoreDisplay = document.getElementById('score'); // スコア表示要素
        const statsContainer = document.getElementById('stats-container'); // 統計情報表示要素
        // resultElement は既に定義されているため、ここでは再定義しない

        let correctAnswer;
        let score = 0;
        let attempts = 0;
        let correctAnswersCount = 0; // 正解数を追跡する新しい変数
        let timer;
        let timerInterval;
        const TIME_LIMIT = 10; // 各問題の制限時間（秒）
        const BONUS_POINTS_PER_SECOND = 1; // 残り1秒あたりのボーナスポイント

        // 難易度管理用の変数
        let operationType = 'addition'; // 'addition', 'subtraction', 'multiplication', 'division'
        let additionLevel = 1;
        let subtractionLevel = 1;
        let multiplicationLevel = 1;
        let divisionLevel = 1;

        // レベルごとの背景色
        const levelColors = {
            addition: {
                1: '#f0f0f0',
                2: '#e0f7fa' // Light Cyan
            },
            subtraction: {
                1: '#e3f2fd', // Light Blue
                2: '#bbdefb'
            },
            multiplication: {
                1: '#fff9c4', // Light Yellow
                2: '#ffcdd2'  // Light Red
            },
            division: {
                1: '#fbe9e7', // Light Deep Orange
                2: '#ffccbc'
            }
        };

        function updateStats() {
            scoreElement.textContent = `スコア: ${score}`;
            attemptsElement.textContent = `問題数: ${attempts}`;
            if (attempts > 0) {
                const accuracy = (correctAnswersCount / attempts) * 100; // correctAnswersCount を使用
                accuracyElement.textContent = `正答率: ${accuracy.toFixed(1)}%`;
            } else {
                accuracyElement.textContent = `正答率: ---`;
            }
        }

        function startTimer() {
            timer = TIME_LIMIT;
            timerElement.textContent = `残り時間: ${timer}秒`;
            timerInterval = setInterval(() => {
                timer--;
                timerElement.textContent = `残り時間: ${timer}秒`;
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    gameOver(); // 時間切れでゲームオーバー
                }
            }, 1000);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerElement.textContent = '';
        }

        function gameOver() {
            resetTimer();
            resultElement.textContent = '時間切れ！ゲームオーバー！';
            resultElement.style.color = 'red';
            answerElement.disabled = true; // 入力欄を無効化
            submitButton.disabled = true; // ボタンを無効化

            playAgainButton.style.display = 'block'; // ボタンを表示
        }

        function resetGame() {
            score = 0;
            attempts = 0;
            correctAnswersCount = 0;
            operationType = 'addition';
            additionLevel = 1;
            subtractionLevel = 1;
            multiplicationLevel = 1;
            divisionLevel = 1;
            // document.body.style.backgroundColor = levelColors.addition[1]; // WordPress環境ではコメントアウト
            answerElement.disabled = false; // 入力欄を有効化
            submitButton.disabled = false; // ボタンを有効化
            playAgainButton.style.display = 'none'; // ボタンを非表示
            resultElement.style.display = 'block'; // 結果表示を再表示
            updateStats();
            generateQuestion();
        }

        function startGame() {
            startScreen.style.display = 'none'; // スタート画面を非表示
            quizContainer.style.display = 'block'; // クイズコンテナを表示
            scoreElement.style.display = 'block'; // スコアを表示
            statsContainer.style.display = 'block'; // 統計情報を表示
            resultElement.style.display = 'block'; // 結果表示を再表示
            updateStats();
            generateQuestion();
        }

        function generateQuestion() {
            resetTimer();
            let num1, num2, questionText;

            if (operationType === 'addition') {
                const min = (additionLevel === 1) ? 1 : Math.pow(10, additionLevel - 1);
                const max = Math.pow(10, additionLevel) - 1;
                num1 = Math.floor(Math.random() * (max - min + 1)) + min;
                num2 = Math.floor(Math.random() * (max - min + 1)) + min;
                correctAnswer = num1 + num2;
                questionText = `${num1} + ${num2} = ?`;
            } else if (operationType === 'subtraction') {
                const min = (subtractionLevel === 1) ? 1 : Math.pow(10, subtractionLevel - 1);
                const max = Math.pow(10, subtractionLevel) - 1;
                num1 = Math.floor(Math.random() * (max - min + 1)) + min;
                num2 = Math.floor(Math.random() * (max - min + 1)) + min;
                if (num1 < num2) [num1, num2] = [num2, num1]; // Ensure positive result
                correctAnswer = num1 - num2;
                questionText = `${num1} - ${num2} = ?`;
            } else if (operationType === 'multiplication') {
                if (multiplicationLevel === 1) {
                    num1 = Math.floor(Math.random() * 9) + 1;
                    num2 = Math.floor(Math.random() * 9) + 1;
                } else { // multiplicationLevel === 2
                    num1 = Math.floor(Math.random() * 90) + 10;
                    num2 = Math.floor(Math.random() * 9) + 1;
                    if (Math.random() > 0.5) [num1, num2] = [num2, num1];
                }
                correctAnswer = num1 * num2;
                questionText = `${num1} × ${num2} = ?`;
            } else { // division
                let divisor, quotient;
                if (divisionLevel === 1) {
                    divisor = Math.floor(Math.random() * 9) + 1;
                    quotient = Math.floor(Math.random() * 9) + 1;
                } else { // divisionLevel === 2
                    divisor = Math.floor(Math.random() * 9) + 1;
                    quotient = Math.floor(Math.random() * 90) + 10;
                }
                const dividend = divisor * quotient;
                correctAnswer = quotient;
                questionText = `${dividend} ÷ ${divisor} = ?`;
            }

            questionElement.textContent = questionText;
            answerElement.value = '';
            resultElement.textContent = '';
            answerElement.focus();
            startTimer();
        }

        function adjustDifficulty() {
            // 5問以上、正答率80%以上でレベルアップ
            if (attempts < 5 || (correctAnswersCount / attempts) <= 0.8) { // correctAnswersCount を使用
                return null;
            }

            const resetStats = () => {
                attempts = 0;
                score = 0;
                correctAnswersCount = 0; // correctAnswersCount もリセット
            };

            let message = null;
            let newBackgroundColor = null;

            if (operationType === 'addition') {
                if (additionLevel < 2) {
                    additionLevel++;
                    message = `レベルアップ！ 次は${additionLevel}桁のたし算！`;
                    newBackgroundColor = levelColors.addition[additionLevel];
                } else {
                    operationType = 'subtraction';
                    subtractionLevel = 1;
                    message = `たし算マスター！ 次はひき算に挑戦だ！`;
                    newBackgroundColor = levelColors.subtraction[subtractionLevel];
                }
            } else if (operationType === 'subtraction') {
                if (subtractionLevel < 2) {
                    subtractionLevel++;
                    message = `レベルアップ！ 次は${subtractionLevel}桁のひき算！`;
                    newBackgroundColor = levelColors.subtraction[subtractionLevel];
                }
            } else if (operationType === 'multiplication') {
                if (multiplicationLevel < 2) {
                    multiplicationLevel++;
                    message = `レベルアップ！ 次は2桁×1桁のかけ算！`;
                    newBackgroundColor = levelColors.multiplication[multiplicationLevel];
                }
            } else if (operationType === 'division') {
                if (divisionLevel < 2) {
                    divisionLevel++;
                    message = `レベルアップ！ 次は「答えが2桁」のわり算！`;
                    newBackgroundColor = levelColors.division[divisionLevel];
                }
            }


            if (message) {
                resetStats();
                // document.body.style.backgroundColor = newBackgroundColor; // WordPress環境ではコメントアウト
            }

            return message;
        }

        function checkAnswer() {
            resetTimer(); // タイマーを停止
            const userAnswer = parseInt(answerElement.value, 10);
            if (isNaN(userAnswer)) {
                resultElement.textContent = '数字を入力してください。';
                resultElement.style.color = 'orange';
                return;
            }

            attempts++;

            if (userAnswer === correctAnswer) {
                correctAnswersCount++; // 正解数をインクリメント
                let pointsEarned = 1; // 基本点
                if (timer > 0) {
                    const bonus = timer * BONUS_POINTS_PER_SECOND;
                    pointsEarned += bonus;
                    resultElement.textContent = `せいかい！ (+${bonus}ボーナスポイント)`;
                } else {
                    resultElement.textContent = 'せいかい！';
                }
                score += pointsEarned;

                const levelUpMessage = adjustDifficulty();
                
                if (levelUpMessage) {
                    resultElement.textContent = levelUpMessage;
                }
                resultElement.style.color = 'green';
                
                updateStats();
                setTimeout(generateQuestion, levelUpMessage ? 2000 : 1000);
            } else {
                resultElement.textContent = 'ざんねん！もういちどためしてね。';
                resultElement.style.color = 'red';
                updateStats();
                setTimeout(generateQuestion, 1000);
            }
        }

        submitButton.addEventListener('click', checkAnswer);

        answerElement.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        });

        // 初期化処理
        playAgainButton.style.display = 'none'; // ボタンを初期状態で非表示にする
        playAgainButton.addEventListener('click', resetGame); // イベントリスナーを追加
        startQuizButton.addEventListener('click', startGame); // スタートボタンのイベントリスナー

        updateStats();
        // generateQuestion(); // 自動開始を削除
    });
</script>
